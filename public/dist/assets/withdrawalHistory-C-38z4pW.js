import{r as c,k as K,j as t,B as I,E as G}from"./index-C-veA1Rv.js";import{u as J,T as Q,d as X}from"./TransactionTable-QW0Nu1id.js";import{C as j,a as N}from"./modal-Cq9y4NFa.js";import{u as Z}from"./useApi-hqwvaQFr.js";import{T as r}from"./Typography-DNw0gmHs.js";import{T as P,F as ee,I as te,S as ae}from"./TextField-CH6IKT9T.js";import{B as se}from"./Button-BUtGUVw6.js";import{M as T}from"./KeyboardArrowRight-BWjR8Xyf.js";import"./DataGridFooter-CqbU6PzW.js";import"./Grow-DEkHVcDO.js";import"./useIsFocusVisible-SVz0b4Hl.js";import"./ButtonBase-DHTngUyU.js";import"./useTheme-CSbpYfTu.js";import"./Tooltip-BeN_8m-j.js";import"./FormControlLabel-X_ttzFaA.js";import"./Toolbar-u8AobN1J.js";import"./index-B9-GP8Fy.js";import"./iconBase-Bz53TZrF.js";import"./dividerClasses-D34xdAHQ.js";const We=({user:B})=>{const[u,L]=c.useState(""),[O,C]=c.useState(!1),[$,D]=c.useState(!1),[E,l]=c.useState(!1),[U,o]=c.useState(""),[W,i]=c.useState("success"),[n,m]=c.useState(null),[f,x]=c.useState(""),[h,b]=c.useState(""),{withdrawals:p}=J(B),{error:v,loading:F,callApi:H}=Z(),d=K(e=>e.user.user),y=(d==null?void 0:d.paymentDetails)||[],S=(d==null?void 0:d._id)||"",q=p.map(e=>{var s,a,w;return{_id:e._id,amount:e.amount,createdAt:e.createdAt instanceof Date?e.createdAt:new Date(e.createdAt||Date.now()),status:e.status,companyName:e.paymentAccountDetails?((s=e.paymentAccountDetails.accountDetails)==null?void 0:s.bankName)||`${((a=e.paymentAccountDetails.currency)==null?void 0:a.toUpperCase())||"Unknown"} Wallet`:"Unknown",type:"withdrawal",currency:(w=e.paymentAccountDetails)==null?void 0:w.currency}}).filter(e=>e._id.toLowerCase().includes(u.toLowerCase())||e.companyName.toLowerCase().includes(u.toLowerCase())||e.status.toLowerCase().includes(u.toLowerCase())),V=e=>{const s=p.find(a=>a._id===e);m(s||null),C(!0)},M=()=>{C(!1),m(null)},Y=e=>{o(`Withdrawal with ID ${e} has been canceled.`),i("success"),l(!0),M()},R=e=>{const s=p.find(a=>a._id===e);m(s||null),D(!0),x(""),b("")},A=()=>{D(!1),m(null),x(""),b("")},k=()=>{l(!1),o(""),i("success")},z=async()=>{if(!n||!S||!f||!h){o("Please select a payment account and enter a withdrawal pin."),i("error"),l(!0);return}if(!/^\d{4}$/.test(h)){o("Withdrawal PIN must be a 4-digit number."),i("error"),l(!0);return}const e=y.find(a=>a._id===f);if(!e){o("Selected payment detail not found."),i("error"),l(!0);return}if(e.type==="fiat"){if(!e.accountDetails.bankName||!e.accountDetails.accountNumber||!e.accountDetails.accountName){o("Fiat payment details must include bank name, account number, and account name."),i("error"),l(!0);return}}else if(e.type==="crypto"&&!e.accountDetails.address){o("Crypto payment details must include a wallet address."),i("error"),l(!0);return}const s={withdrawalId:n._id,userId:S,paymentAccountDetails:e,withdrawalPin:h};try{const a=await H({url:G.MAKE_WITHDRAWAL,method:"POST",body:s});o(a.message),i("success"),l(!0),A()}catch(a){const w=a.status===401?"Invalid withdrawal PIN.":a.status===400?a.message||"Invalid request data.":a.status===403?"Unauthorized action.":a.status===404?"Withdrawal not found.":a.status===503?"Database error. Please try again later.":"Failed to process withdrawal.";o(w),i("error"),l(!0)}},_=e=>{const s=[{icon:"eva:eye-fill",label:"View Details",onClick:()=>V(e._id)}];return e.status==="pending"&&s.push({icon:"eva:close-circle-fill",label:"Cancel Withdrawal",onClick:()=>Y(e._id)}),e.status==="approved"&&s.push({icon:"eva:checkmark-circle-fill",label:"Make Withdrawal",onClick:()=>R(e._id)}),s},g=2;return t.jsxs(I,{children:[t.jsx(r,{variant:"h4",mb:3,children:"Withdrawal History"}),t.jsx(P,{label:"Search Bank/Wallet or Status",variant:"outlined",value:u,onChange:e=>L(e.target.value),fullWidth:!0,sx:{mb:3,maxWidth:400}}),t.jsx(I,{height:500,children:t.jsx(Q,{searchText:u,itemsPerPage:10,transactions:q,actions:e=>{const s=p.find(a=>a._id===e._id);return s?_(s):[]}})}),t.jsx(j,{open:O,title:"Withdrawal Details",onCancel:M,noConfirm:!0,children:n?t.jsxs(N,{children:[t.jsxs(r,{variant:"body1",children:[t.jsx("strong",{children:"ID:"})," ",n._id]}),t.jsxs(r,{variant:"body1",children:[t.jsx("strong",{children:"Amount:"})," ",n.amount]}),t.jsxs(r,{variant:"body1",children:[t.jsx("strong",{children:"Status:"})," ",n.status.charAt(0).toUpperCase()+n.status.slice(1)]}),t.jsxs(r,{variant:"body1",children:[t.jsx("strong",{children:"Date:"})," ",X(n.createdAt).format("MMM DD, YYYY HH:mm")]}),_(n).map((e,s)=>t.jsx(se,{variant:"contained",color:e.label==="Cancel Withdrawal"?"error":"primary",onClick:e.onClick,sx:{mt:2},children:e.label},s))]}):t.jsx(r,{children:"No details available"})}),t.jsx(j,{open:$,title:"Make Withdrawal",onCancel:A,onConfirm:z,noConfirm:!1,children:n?t.jsxs(N,{children:[t.jsxs(r,{variant:"body1",children:[t.jsx("strong",{children:"Withdrawal ID:"})," ",n._id]}),t.jsxs(r,{sx:{marginBottom:g},variant:"body1",children:[t.jsx("strong",{children:"Amount:"})," ",n.amount]}),t.jsxs(ee,{fullWidth:!0,children:[t.jsx(te,{sx:{marginBottom:g},id:"payment-detail-label",children:"Select Payment Account"}),t.jsx(ae,{labelId:"payment-detail-label",value:f,label:"Select Payment Account",onChange:e=>x(e.target.value),disabled:y.length===0,sx:{marginBottom:g},children:y.length===0?t.jsx(T,{value:"",disabled:!0,children:"No payment accounts available"}):y.map(e=>t.jsx(T,{value:e._id,children:e.type==="fiat"?`${e.accountDetails.bankName||"Unknown Bank"} - ${e.accountDetails.accountNumber||"Unknown"}`:`${e.currency.toUpperCase()} Wallet - ${e.accountDetails.address||"Unknown Address"}`},e._id))})]}),t.jsx(P,{label:"Withdrawal Pin",type:"password",value:h,onChange:e=>b(e.target.value),fullWidth:!0,required:!0}),v&&t.jsx(r,{color:"error",variant:"body2",children:v.message}),F&&t.jsx(r,{variant:"body2",children:"Submitting withdrawal request..."})]}):t.jsx(r,{children:"No withdrawal selected"})}),t.jsx(j,{open:E,title:W==="success"?"Success":"Error",onCancel:k,onConfirm:k,noConfirm:!1,children:t.jsx(r,{variant:"body1",color:W==="success"?"success.main":"error.main",sx:{py:2},children:U})})]})};export{We as default};
